# CP 数据处理器 - 开发者文档

> **半导体晶圆 CP 测试数据分析平台开发与迭代指南**

## 📋 目录

- [项目概览](#项目概览)
- [系统架构](#系统架构)
- [最新功能实现](#最新功能实现)
- [模块详细说明](#模块详细说明)
- [开发指南](#开发指南)
- [版本演进记录](#版本演进记录)
- [后续迭代计划](#后续迭代计划)

## 项目概览

本项目是原始 VBA CP 数据处理宏的 Python 转换版本，专注于复刻和升级读取多种 CP 测试数据格式 (MEX, DCP, CW)、处理数据、计算统计数据和良率、生成分析图表的核心功能。

### 🔄 重构背景

原始程序基于Excel VBA实现，存在以下问题：

1. **维护困难**：代码耦合度高，模块间依赖复杂
2. **性能瓶颈**：脚本执行效率低，难以处理大量数据
3. **平台限制**：依赖Windows和MS Office，跨平台支持困难

通过Python重构提供了模块化、可扩展、高效的解决方案。

### 📊 当前版本状态

**版本**：v1.2  
**最后更新**：2025-01-06  
**主要特性**：

- ✅ 完整的GUI界面（PyQt5）
- ✅ YieldChart良率分析模块
- ✅ BoxplotChart参数分析模块
- ✅ 汇总图表功能
- ✅ 智能数据清洗
- ✅ .pyz打包发布

## 系统架构

采用现代化的模块化架构设计：

```
CP数据处理器
├── 🗂️ 数据读取层 (readers)       # 解析不同格式的原始数据
├── 📊 数据模型层 (data_models)   # 定义核心数据结构
├── ⚙️ 数据处理层 (processing)   # 数据清洗、转换、计算
├── 📈 数据分析层 (analysis)     # 统计分析、良率计算
├── 🎨 数据可视化层 (plotting)   # 生成各类交互式图表
├── 📤 数据导出层 (exporters)    # 将结果保存为文件
├── 🖥️ 应用层 (app/cli/gui)     # 用户接口和主流程控制
└── 🎯 前端图表 (frontend)       # 现代化图表组件
```

### 核心架构原则

- **关注点分离**：每个模块负责特定功能
- **松耦合设计**：模块间通过明确接口交互
- **可扩展性**：易于添加新功能和支持新数据格式
- **可测试性**：组件易于单独测试

## 最新功能实现

> 基于功能实现总结.md的内容整合

### ✅ YieldChart 模块实现

#### 1. 批次良率折线图

- **实现方法**：`_create_wafer_trend_chart()`
- **功能特点**：
  - 显示各批次wafer良率随wafer编号的变化趋势
  - 多批次对比，不同颜色区分
  - 包含平均良率参考线
  - 交互式悬停显示详细信息
- **输出文件**：`Wafer良率趋势分析_yield_chart.html`

#### 2. 失效类型分析

- **实现方法**：`_create_failure_analysis_chart()`
- **功能特点**：
  - 分析Bin3-Bin9的失效分布情况
  - 饼图显示失效类型占比
  - 自动过滤零值bin
- **输出文件**：`失效类型分析_yield_chart.html`

#### 3. 批次良率分析对比

- **实现方法**：`_create_lot_comparison_chart()`
- **功能特点**：
  - 对比不同批次的平均良率和标准差
  - 柱状图显示，包含误差棒
  - 显示每个批次的wafer数量
- **输出文件**：`批次良率对比分析_yield_chart.html`

### ✅ BoxplotChart 模块实现

#### 核心特性

- **数据来源**：基于清洗后的die-level测试数据
- **X轴双层显示**：上层显示Wafer编号，下层显示批次信息
- **箱体图+散点图组合**：显示分布统计和所有数据点
- **规格限制线**：自动从spec数据提取上下限
- **异常值检测**：自动识别和标注异常值

### 🆕 汇总图表功能

#### 功能特点

- **良率分析集成**：顶部显示Wafer良率趋势图
- **一页显示所有参数**：将所有参数的箱体图合并显示
- **X轴完美对齐**：良率图和参数图共享相同X轴配置
- **交互功能保持**：支持缩放、平移、悬停等交互操作

### 📊 数据处理现状

#### 支持的数据格式

- **输入格式**：DCP, CW, MEX
- **输出格式**：
  - `*_yield_*.csv` - 良率数据
  - `*_spec_*.csv` - 规格数据
  - `*_cleaned_*.csv` - 清洗数据

#### 处理能力

- **批次处理**：支持多批次数据同时分析
- **参数支持**：11个标准参数的完整分析
- **异常处理**：IQR方法异常值检测
- **单位转换**：自动单位标准化

## 模块详细说明

### 1. 数据读取模块 (readers)

负责从不同格式文件提取CP测试数据，采用工厂模式设计。

#### 关键组件

- **BaseReader**：定义统一接口
- **DCPReader**：处理DCP格式数据
- **CWReader**：处理CSV/CW格式数据
- **MEXReader**：处理Excel/MEX格式数据

#### 使用示例

```python
# 使用读取器工厂
reader = create_reader("dcp")
data = reader.read("path/to/file.txt")
```

### 2. 数据模型模块 (data_models)

定义核心数据结构，使用Python dataclass实现。

#### 核心数据结构

- **CPLot**：表示完整的CP测试批次
- **CPWafer**：表示单个晶圆的测试数据
- **CPParameter**：表示测试参数的定义和规格

### 3. 数据处理模块 (processing)

负责数据清洗、转换和增强。

#### 主要功能

- **DataTransformer类**：核心数据处理功能
  - 异常值检测：IQR和标准差方法
  - 数据转换：单位转换、归一化
  - 数据增强：计算派生参数

#### 使用示例

```python
transformer = DataTransformer(test_info)
transformer.clean_outliers(method='iqr', threshold=1.5)
processed_data = transformer.data
```

### 4. 前端图表模块 (frontend)

现代化的图表生成系统，基于Plotly构建。

#### 核心组件

- **YieldChart**：良率分析图表
- **BoxplotChart**：参数分布分析
- **SummaryChart**：汇总分析图表

#### 特性

- 交互式HTML图表
- 响应式设计
- 本地化JavaScript嵌入
- 统一的样式系统

## 开发指南

### 🔧 环境配置

```bash
# 克隆代码库
git clone <repository>

# 安装依赖
pip install -r requirements.txt

# 推荐Anaconda2024
python --version
```

### 🆕 添加新功能

#### 支持新数据格式

1. 在`readers`目录创建新读取器，继承`BaseReader`
2. 实现`read`方法解析特定格式
3. 在`reader_factory.py`中注册新格式

```python
class NewFormatReader(BaseReader):
    def read(self, file_paths):
        # 实现读取逻辑
        return data
```

#### 添加新图表类型

1. 在`frontend/charts`目录创建新组件
2. 继承基础图表类
3. 实现特定的可视化逻辑

```python
class NewChartType(BaseChart):
    def create_chart(self):
        # 实现图表生成逻辑
        return fig
```

### 🧪 测试指南

#### 单元测试

```bash
# 运行所有测试
python -m pytest tests/

# 运行特定模块测试
python -m pytest tests/test_readers.py
```

#### 集成测试

```bash
# 测试完整流程
python chart_generator.py
```

### 📝 代码规范

- 遵循PEP 8编码规范
- 添加详细文档字符串
- 使用类型注解
- 编写单元测试

## 版本演进记录

### v1.2 (2025-01-06) - 当前版本

**重要修复**：

- 🎯 **X轴显示修复**：修复良率图表X轴范围限制问题
- 🔧 **汇总图表集成**：添加完整的汇总分析功能
- 📦 **打包系统更新**：使用.pyz打包替代conda-pack

**详细修复**：

```python
# 修复前：硬编码范围导致数据截断
if total_wafers > 50:
    initial_range = [-0.5, 49.5]  

# 修复后：动态范围覆盖所有数据
x_range_end = len(x_labels) - 0.5
range=[x_range_start, x_range_end]
```

### v1.1 (2024-11) - 主要重构

- 🏗️ **架构重构**：从过程式代码重构为面向对象设计
- 🎨 **前端模块**：添加现代化图表系统
- 🖥️ **GUI增强**：PyQt5界面替代Tkinter

### v1.0 (2024-05) - 模块化完善

- 📊 **散点图功能**：添加参数相关性分析
- 📈 **Yield计算器重构**：独立良率计算模块
- 📁 **Reader模块整理**：统一数据读取接口
- 🔧 **DCP读取器启用**：完整支持DCP格式

### v0.9 (2023-12) - 核心功能

- 🏛️ **基础架构建立**：模块化设计实现
- 📊 **图表系统**：箱体图、晶圆图、散点图
- 🔄 **数据处理流程**：完整的ETL流程

## 后续迭代计划

### 🎯 近期目标 (Q1 2025)

#### 性能优化

- [ ] **并行处理**：支持多核数据处理
- [ ] **内存优化**：大数据集流式处理
- [ ] **缓存机制**：智能结果缓存

#### 功能扩展

- [ ] **新图表类型**：热力图、雷达图、关联分析
- [ ] **报告系统**：自动生成PDF报告
- [ ] **数据库支持**：PostgreSQL/SQLite集成

#### 用户体验

- [ ] **Web界面**：基于Flask/Django的Web版本
- [ ] **配置管理**：可视化配置编辑器
- [ ] **批处理优化**：文件夹监控自动处理

### 🚀 长期规划 (2025)

#### 智能化升级

- [ ] **机器学习**：异常检测算法优化
- [ ] **预测分析**：良率趋势预测
- [ ] **智能建议**：参数优化建议系统

#### 企业级特性

- [ ] **多用户支持**：权限管理和用户系统
- [ ] **API服务**：RESTful API接口
- [ ] **集成支持**：与MES/ERP系统集成

#### 生态系统

- [ ] **插件系统**：第三方扩展支持
- [ ] **模板市场**：图表模板共享
- [ ] **云端部署**：Docker容器化部署

## 🤖 AI辅助开发指南

为便于AI工具理解和改进代码，建议关注：

### 代码结构模式

- **工厂模式**：读取器创建
- **策略模式**：数据处理算法
- **观察者模式**：状态更新通知
- **装饰器模式**：功能增强

### 扩展点设计

- **数据源扩展**：新格式支持
- **算法扩展**：新分析方法
- **可视化扩展**：新图表类型
- **导出扩展**：新输出格式

### AI协助任务格式

```
需求：[简要描述]
模块：[相关代码模块]
输入：[期望输入格式]
输出：[期望输出格式]
约束：[性能、兼容性要求]
```

## 🤝 贡献指南

### 开发流程

1. Fork代码库并创建特性分支
2. 实现功能并编写测试
3. 更新相关文档
4. 提交Pull Request

### 质量检查

- 代码通过所有单元测试
- 符合项目编码规范
- 添加必要的文档说明
- 性能影响评估

### 发布流程

1. 版本号更新
2. CHANGELOG更新
3. 文档同步更新
4. 打包测试验证

---

**维护者**：chao  
**技术支持**：通过Issues系统提交问题  
**文档版本**：v1.2 - 2025-06-06
