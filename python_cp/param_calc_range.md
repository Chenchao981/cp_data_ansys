# 参数计算范围定义 (`参数计算范围定义.py`)

该模块用于从 Excel 文件中加载特定产品的参数计算范围限制。这些范围可以在后续的参数统计分析中用于筛选数据。

## 主要功能

### `load_scope_limits_from_excel(file_path: str, sheet_name: str, product_name: str) -> Optional[Dict[str, Tuple[Optional[float], Optional[float]]]]`

此函数模拟 VBA 脚本 `vbas/参数计算范围定义.bas` 中 `GetProductScopeDefine` 函数的行为。

**工作流程:**

1.  **读取 Excel**: 使用 `pandas` 读取指定的 `file_path` 和 `sheet_name`。
2.  **查找产品**: 在工作表的第一列（A 列）中查找指定的 `product_name`（不区分大小写，忽略前后空格）。查找从第二行开始。
3.  **定位范围行**:
    *   如果找到产品名称，确定其所在的行号 `N`。
    *   参数标识符（Parameter IDs）预期在第 `N-1` 行。
    *   计算范围的下限（Lower Limits）预期在第 `N+1` 行。
    *   计算范围的上限（Upper Limits）预期在第 `N+2` 行。
4.  **提取数据**: 提取这三行的数据。
5.  **构建字典**:
    *   遍历参数标识行（从第二列 B 列开始）。
    *   对于每个有效的参数标识符，从下限行和上限行获取对应的数值。
    *   将非数字或空单元格视为 `None`。
    *   构建一个字典，其中键是参数标识符（字符串），值是一个 `(下限, 上限)` 的元组，元组中的元素可以是 `float` 或 `None`。
6.  **返回结果**:
    *   如果成功找到产品并提取了至少一个有效的范围，返回包含范围信息的字典。
    *   如果找到了产品但未能提取任何有效范围，返回一个空字典 `{}`。
    *   如果未找到产品名称、文件或工作表不存在、或发生其他读取错误，返回 `None`。

**Excel 文件格式要求:**

*   工作表的第一列（A 列）包含产品名称列表，从第二行开始。
*   对于要查找的产品名称所在的行 `N`：
    *   第 `N-1` 行包含参数的标识符（例如参数名称），从第二列（B 列）开始。
    *   第 `N+1` 行包含对应参数的计算范围下限，从第二列（B 列）开始。
    *   第 `N+2` 行包含对应参数的计算范围上限，从第二列（B 列）开始。
    *   空单元格或非数字值将被解释为无限制 (`None`)。

**示例 Excel 结构 (`sheet_name='ScopeSheet'`)**:

|     | A          | B       | C      | D       | ... |
| --- | ---------- | ------- | ------ | ------- | --- |
| 1   |            | Param1  | Param2 | Param3  | ... |
| 2   | ProductA   |         |        |         | ... | <- 假设查找 ProductA，此为行 N=2
| 3   |            | 0.1     | 10     |         | ... | <- 下限行 (N+1)
| 4   |            | 0.5     | 100    | 50      | ... | <- 上限行 (N+2)
| 5   | ProductB   |         |        |         | ... |
| 6   |            | 1.0     |        |         | ... |
| 7   |            | 5.0     | 200    | 99      | ... |
| ... | ...        | ...     | ...    | ...     | ... |

调用 `load_scope_limits_from_excel(..., product_name='ProductA')` 应该返回：
```python
{'Param1': (0.1, 0.5), 'Param2': (10.0, 100.0), 'Param3': (None, 50.0)}
```
注意 `Param3` 的下限为 `None` 因为对应的单元格为空。

## 使用场景

此模块加载的范围字典 (`scope_limits`) 可以传递给 `参数分布统计` 模块中的 `calculate_parameter_summary` 函数的 `scope_limits` 参数，以便在计算统计数据之前根据这些范围筛选数据点。

## 依赖项

*   `pandas`: 用于读取 Excel 文件。
*   `logging`: 用于记录操作信息和错误。 