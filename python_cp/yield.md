# yield.md - 良率报告生成规范

## 1. 功能概述

本模块（或脚本）旨在根据已清洗的半导体晶圆测试数据（通常是 `*_cleaned_*.csv` 文件），生成一个详细的良率报告。该报告将以CSV格式（`*_yield_*.csv`）输出，包含每个晶圆的良率信息以及整个批次的汇总统计。

## 2. 输入数据

*   **来源**：由主数据处理流程（例如 `clean_dcp_data.py`）生成的、经过清洗和列排序的CSV文件。
*   **关键输入列**（预计存在于输入CSV中）：
    *   `Lot_ID`: 批次标识。
    *   `Wafer_ID`: 晶圆标识。
    *   `Bin`: 每个Die的Bin分类值（数值型）。
    *   其他参数列（用于数据完整性，但非直接用于良率计算核心字段）。

## 3. 输出文件 (`yield.csv`)

*   **文件名规则**：与输入的清洗后数据文件保持一致的命名结构，但将 `_cleaned_` 部分替换为 `_yield_`。
    *   例如：如果输入是 `LOTXYZ_timestampA_cleaned_timestampB.csv`，则输出应为 `LOTXYZ_timestampA_yield_timestampB.csv`。
*   **格式**：CSV (逗号分隔值)。
*   **内容结构**：
    *   第一行为表头。
    *   后续每行代表一个独立晶圆的良率数据。
    *   最后一行是整个批次的汇总统计，标记为 "ALL"。

## 4. 输出字段定义 (`yield.csv` 的列)

| 字段名    | 描述                                                                 | 数据类型 (CSV中) | 晶圆行示例    | "ALL"行示例 | 备注                                                                 |
| :-------- | :------------------------------------------------------------------- | :--------------- | :------------ | :---------- | :------------------------------------------------------------------- |
| `Lot_ID`  | 批次标识符                                                           | String           | "FA54-..."    | "ALL"       | 从输入数据获取；"ALL"行固定为 "ALL"                                     |
| `Wafer_ID`| 晶圆标识符                                                           | String           | "1", "2", ... | "ALL"       | 从输入数据获取；"ALL"行固定为 "ALL"                                     |
| `Yield`   | 良率                                                                 | String           | "98.45%"      | "98.18%"    | 格式为百分比，保留两位小数；"ALL"行为批次内所有晶圆良率的算术平均值 |
| `Total`   | 总Die数量                                                            | Integer          | 193           | 4825        | "ALL"行为批次内所有晶圆Total的累加                                   |
| `Pass`    | Bin 1 的Die数量                                                      | Integer          | 190           | 4737        | "ALL"行为批次内所有晶圆Pass的累加                                    |
| `Bin3`    | Bin 3 的Die数量                                                      | Integer          | (空或0)       | 10          | "ALL"行为批次内所有晶圆Bin3的累加；若计数为0，显示0          |
| `Bin4`    | Bin 4 的Die数量                                                      | Integer          | 1             | 19          | "ALL"行为批次内所有晶圆Bin4的累加；若计数为0，显示0          |
| `Bin6`    | Bin 6 的Die数量                                                      | Integer          | 2             | 51          | "ALL"行为批次内所有晶圆Bin6的累加；若计数为0，显示0          |
| `Bin7`    | Bin 7 的Die数量                                                      | Integer          | (空或0)       | 3           | "ALL"行为批次内所有晶圆Bin7的累加；若计数为0，显示0          |
| `Bin8`    | Bin 8 的Die数量                                                      | Integer          | (空或0)       | 2           | "ALL"行为批次内所有晶圆Bin8的累加；若计数为0，显示0          |
| `Bin9`    | Bin 9 的Die数量                                                      | Integer          | (空或0)       | 3           | "ALL"行为批次内所有晶圆Bin9的累加；若计数为0，显示0          |

*   **空值/0值表示**：如果某个Bin的计数为0，在CSV中应明确显示为 `0`。

## 5. 计算逻辑

### 5.1. 单个晶圆 (`Wafer_ID`) 数据计算

对于从输入CSV中按 `Wafer_ID` 分组的每一片晶圆：
1.  **`Lot_ID`**: 直接从该晶圆数据中获取。
2.  **`Wafer_ID`**: 当前分组的 `Wafer_ID`。
3.  **`Total`**: 该 `Wafer_ID` 在输入数据中的总行数（即总Die数）。
4.  **`Pass`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `1` 的行数。
5.  **`Yield`**: `(Pass / Total) * 100`。结果需格式化为带两位小数的百分比字符串 (如 "98.45%")。如果 `Total` 为0，`Yield` 应为 "0.00%"。
6.  **`Bin3`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `3` 的行数。
7.  **`Bin4`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `4` 的行数。
8.  **`Bin6`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `6` 的行数。
9.  **`Bin7`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `7` 的行数。
10. **`Bin8`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `8` 的行数。
11. **`Bin9`**: 该 `Wafer_ID` 数据中，`Bin` 列值为 `9` 的行数。

### 5.2. "ALL" 行（批次汇总）数据计算

1.  **`Lot_ID`**: 固定字符串 "ALL"。
2.  **`Wafer_ID`**: 固定字符串 "ALL"。
3.  **`Total`**: 所有单个晶圆 `Total` 值的总和。
4.  **`Pass`**: 所有单个晶圆 `Pass` 值的总和。
5.  **`Yield`**: 计算所有单个晶圆 `Yield` 值（数值形式，非百分比字符串）的算术平均值。然后将此平均值格式化为带两位小数的百分比字符串。如果所有晶圆的Total都为0，则批次Yield为 "0.00%"。
6.  **`Bin3`**: 所有单个晶圆 `Bin3` 计数的总和。
7.  **`Bin4`**: 所有单个晶圆 `Bin4` 计数的总和。
8.  **`Bin6`**: 所有单个晶圆 `Bin6` 计数的总和。
9.  **`Bin7`**: 所有单个晶圆 `Bin7` 计数的总和。
10. **`Bin8`**: 所有单个晶圆 `Bin8` 计数的总和。
11. **`Bin9`**: 所有单个晶圆 `Bin9` 计数的总和。

## 6. 实现考虑

*   **模块化**：建议将此逻辑封装在一个独立的Python模块/文件中（例如 `yield_processing.py`），其中包含一个主函数，如 `generate_yield_report(input_df, output_filepath)` 或 `generate_yield_report(input_filepath, output_filepath)`。
*   **集成点**：此功能应在主数据处理脚本（如 `clean_dcp_data.py`）的 `process_lot_data` 函数中，在主要的 `_cleaned_*.csv` 文件生成之后被调用。
*   **错误处理**：应考虑输入文件不存在、`Bin`列缺失等情况。
*   **Pandas库**：强烈建议使用Pandas库进行数据读取、分组、聚合和计算。
*   **数值精度**：Yield百分比保留两位小数。

## 7. 示例输出（结构参考）

```csv
Lot_ID,Wafer_ID,Yield,Total,Pass,Bin3,Bin4,Bin6,Bin7,Bin8,Bin9
FA54-...,1,98.45%,193,190,0,1,2,0,0,0
FA54-...,2,98.45%,193,190,0,1,2,0,0,0
FA54-...,3,97.41%,193,188,1,2,2,0,0,0
...
ALL,ALL,98.18%,4825,4737,10,19,51,3,2,3
``` 